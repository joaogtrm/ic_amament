---
  title: "ic_amamentação"
  output: 
  html_document:
  date: "2023-10-19"
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  include = TRUE
)
knitr::opts_chunk$set(warning = F, message = F)
```

# Análise descritiva

## Carregamento da base e limpeza 

### carregamento das bibliotecas

```{r, warning=F, message=F}
library(tidyverse)    ### coleção de pacotes
library(janitor)      ### manipular variaveis
library(haven)        ### ler o pacote .sav    
library(labelled)     ### obter o dicionário das variaveis  
library(ggplot2)      ### construção de gráficos 
library(survival)     ### análise de sobrevivência
#library(corrr)        ### talvez
library(ggfortify)    ### talvez
library(summarytools) ### talvez
library(knitr)        ### aparência de tabelas
library(kableExtra)   ### aparência de tabelas
library(RCurl)        ### importar base do github
```

### Carregamento, limpeza da base, e criação do dicionário

```{r include=FALSE}
# importação da base de dados+clean_names()
link <- ("https://github.com/joaogtrm/ic_amament/raw/main/dados-amamentacao.sav")
df_geral <- read_sav(link) %>% clean_names()
df_geral <- df_geral %>% 
  janitor::clean_names() %>%
  dplyr::filter(!is.na(tempo_vida_ate_parada_amament_ate180)==TRUE) %>% 
  dplyr::filter(!is.na(censura)==TRUE) %>% 
  dplyr::rename(tempo=tempo_vida_ate_parada_amament_ate180) 
## gerando dicionário
dicionario <- df_geral %>% 
  janitor::clean_names()%>% 
  labelled::generate_dictionary()
# separando vetores por tipos 
## vetor com tempos t1,t2,t3
temp_n <- c("t1_amamen_exclusiva_sn","t2_amamen_exclusiva_sn","t3_amamen_exclusiva_sn","t1_retorno_ao_trabalho","t2_retorno_trabalho","t3_retorno_trabalho")
## variaveis de identificação
var_id <- c("n_rand", "grupo", "indic_gemelar", "indic_mae", "indic_info_ganho_peso", "indic_t", "indic_tempo","filter")
## variaveis numéricas
var_num <- c(
  "ig_inclus_corrigida", "horas_trab_dia", "salario_familiar", "idade",
  "dias_int_mae_pos_parto", "ig_parto", "num_filhos_amamentou_todos","media_amament_prev_meses_todos",
  "peso_nasc", "uti_t_int_todos", "total_t_int", "ganho_peso_por_dia", "tempo","censura")
## variaveis de fator
#### variaveis de sim ou não numerico
var_sn <- c("religiao_sn", "para_sn", "horas_trab_menor_igual7", "horas_trab_menor_7", "idade_menor26", "idade_menor_igual26", "dias_int_mae_pos_parto_menor_igual3", "dias_int_mae_pos_parto_menor3", "ig_parto_36", "ig_parto_37", "ajuda_para_cuidar", "dificuldade_para_amamentar", "dor_amamentar", "media_amament_prev_12", "peso_nasc_2300", "total_t_int_menor11", "ganho_peso_por_dia_menor_igual21", "amamen_exclusiva_sn", "censura", "retorno_trabalho", "trabalha_sn", "mora_com_compan", "af_ca_mama", "orien_amam_prev", "gravid_plan", "gravid_desej", "complic_relac_parto", "uti", "amament_prev_sn")
#### variaveis de fator numerico
var_fct_chr <- c("religiao_catolica_sn","salario_familiar_cat","salario_familiar_2cat","idade_faixa_et","escolaridade_cat","mamilos", "tipo_parto", "sexo")
#### variaveis de sim ou não 
var_sn_n <- c(
  "religiao_sn", "para_sn",
  "horas_trab_menor_igual7", "horas_trab_menor_7",
  "idade_menor26", "idade_menor_igual26",
  "dias_int_mae_pos_parto_menor_igual3", "dias_int_mae_pos_parto_menor3",
  "ig_parto_36", "ig_parto_37", "ajuda_para_cuidar",
  "dificuldade_para_amamentar", "dor_amamentar",
  "media_amament_prev_12", "peso_nasc_2300",
  "total_t_int_menor11", "ganho_peso_por_dia_menor_igual21",
  "t1_amamen_exclusiva_sn", "t2_amamen_exclusiva_sn", "t3_amamen_exclusiva_sn", "amamen_exclusiva_sn",
  "censura", "retorno_trabalho"
)
#### variaveis de fator numerico
var_fct_chr_n <- c("religiao_catolica_sn","salario_familiar_cat", "salario_familiar_2cat","idade_faixa_et","escolaridade_cat"
)
### mudando valores das variaveis de fator usando dicionário 
var_fct_n <- union(var_fct_chr_n,var_sn_n)
df_geral[,var_fct_n] <- lapply(df_geral[,var_fct_n], as_factor)
# mudando classe das variaveis 
## variaveis de fator 
var_fct <-union(var_fct_chr,var_sn)
df_geral[,var_fct] <- lapply(df_geral[,var_fct], as.factor)
## variaveis numéricas
df_geral[,var_num] <- lapply(df_geral[,var_num],as.integer)
##limpando a base, removendo os dois valores perdidos durante acompanhamento
#df_geral <- df_geral %>% 
#  janitor::clean_names() %>%
#  dplyr::filter(!is.na(tempo_vida_ate_parada_amament_ate180)==TRUE) %>% 
#  dplyr::filter(!is.na(censura)==TRUE) %>% 
#  dplyr::rename(tempo=tempo_vida_ate_parada_amament_ate180) 
```

## descritiva dados maternos

```{r}
## vetor com nomes dos dados que voltados a mãe
vet_nao_mae <- c("n_rand", "grupo", "indic_gemelar", "indic_info_ganho_peso", "indic_t", "indic_tempo","filter","sexo","peso_nasc","peso_nasc_2300","uti","uti_t_int_todos","total_t_int", "total_t_int_menor11","ganho_peso_por_dia","ganho_peso_por_dia_menor_igual21")
vet_mae <- setdiff(names(df_geral), c(vet_nao_mae))
## duvidas: variaveis "uti",uti_t_int_todos" , "total_t_int", "total_t_int_menor11", são dos filhos, mas necessáriamente se um gêmeo foi internado, o outro também será? eu os retirei
```

### dados numéricos maternos

```{r}
#dados numéricos
df_mae_num <- df_geral %>% 
  dplyr::filter(indic_mae==1) %>% 
  dplyr::select(intersect(var_num,vet_mae))
med_var_mae <- data.frame(media=round(colMeans(df_mae_num, na.rm = TRUE),3), SD=round(sqrt(apply(df_mae_num, 2, var, na.rm = TRUE)),3))
med_var_mae %>% kbl() %>%kable_styling()
```

### dados de fatores maternos 

```{r results='asis'}

df_mae_fator <- df_geral %>% 
  dplyr::filter(indic_mae==1) %>% dplyr::select(c(intersect(vet_mae,var_fct)))
a <- list()
for (i in names(df_mae_fator)){
  nome_2 <- "frequencia da variavel"
  nome_2 <- paste(nome_2, i)
  var <- df_mae_fator[[i]]
  a[[i]] <- as.data.frame(table(var)) %>% kable() %>% kable_styling()
  print(a[[i]])
}
```

## descritiva bebê

### dados numéricos bebês

```{r}
df_mae_num <- df_geral %>% 
  dplyr::select(intersect(var_num,vet_nao_mae))
med_var_mae <- data.frame(media=colMeans(df_mae_num, na.rm = TRUE), variancia=apply(df_mae_num, 2, var, na.rm = TRUE))
med_var_mae %>% kbl() %>%kable_styling()
```

### dados de fatores bebês

```{r results='asis'}
df_mae_fator <- df_geral %>%
  dplyr::select(c(intersect(vet_nao_mae,var_fct)))
a <- list()
for (i in names(df_mae_fator)){
  nome_2 <- "frequencia da variavel"
  nome_2 <- paste(nome_2, i)
  var <- df_mae_fator[[i]]
  a[[i]] <- as.data.frame(table(var)) %>% kable() %>% kable_styling()
  print(a[[i]])
}
```

# Análise de sobrevivência
```{r}
# separando variaveis de fator por numero de fatores 
df_geral <- df_geral %>% select(-temp_n)
## estava encontrando alguns problemas, então dividi as variáveis em relação ao número de fatores 
fatores_3 <- c("religiao_catolica_sn","salario_familiar_cat","mamilos","escolaridade_cat")
fatores_4 <- c("idade_faixa_et")
fatores_2 <- c(setdiff(intersect(names(df_geral),var_fct), union(fatores_3, fatores_4)))

```

## para variáveis com 2 fatores

### Tabela com todas variaveis com diferença significânte entre as curvas(pvalor), pelo teste de logrank, com seus respectivos pvalores ao lado 

```{r}
#df_geral$censura <- as.numeric(df_geral$censura)
v_imp <- list()
v_imp_nome <- list()
lr_df <- as.data.frame(list()) %>%  mutate(variavel=NA,valor_p=NA)
for (i in names(df_geral %>% select(fatores_2))){
  lrv<- survdiff(Surv(df_geral$tempo,df_geral$censura)~df_geral[[i]])
  if (lrv$pvalue<0.05){
    v_imp_nome[i] <- i
    v_imp[i] <- lrv
    lr_df <- rbind(lr_df, data.frame(variavel = i, valor_p = round(lrv$pvalue,3)))    
    }
}
lr_df %>% kbl() %>% kable_styling()
```

### curvas de kaplan-meier de cada variavel que apresentou pvalor significativo

```{r eval=FALSE, include=FALSE, results='asis'}
ekm <- list()
for (i in names(v_imp_nome)){
  ekm[[i]] <- survfit(Surv(df_geral$tempo,df_geral$censura)~df_geral[[i]])
  plot <- autoplot(ekm[[i]],main = paste("curva de Kaplan-Meier para ",i),surv.connect=F)
  print(plot)
}
```
